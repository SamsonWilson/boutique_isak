{% extends "base.html" %}
{% load static %}

{% block title %}Tableau de Bord - Gestion multi-boutiques{% endblock %}

{% block content %}


<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Système de Caisse Simple</title>
    <style>
        /* Styles Généraux */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            margin: 0;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1, h2 {
            color: #1c2e4a;
            border-bottom: 2px solid #e1e4e8;
            padding-bottom: 10px;
        }

        /* Section Recherche */
        .search-section {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
        }

        #product-search {
            width: 100%;
            padding: 12px;
            border: 1px solid #ccc;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box; /* Important pour que le padding n'ajoute pas à la largeur */
        }

        #search-results {
            border: 1px solid #ddd;
            border-radius: 6px;
            margin-top: 5px;
            max-height: 200px;
            overflow-y: auto;
        }

        .result-item {
            padding: 12px;
            cursor: pointer;
            border-bottom: 1px solid #eee;
        }

        .result-item:last-child {
            border-bottom: none;
        }

        .result-item:hover {
            background-color: #f7f7f7;
        }

        /* Section Reçu */
        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .receipt-table th, .receipt-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e1e4e8;
        }

        .receipt-table th {
            background-color: #f8f9fa;
            font-weight: 600;
        }

        .receipt-table td.price, .receipt-table th.price {
            text-align: right;
        }

        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
        }
        .delete-btn:hover {
            background-color: #c0392b;
        }

        /* Section Total et Actions */
        .total-section {
            margin-top: 20px;
            text-align: right;
        }

        #total-price {
            font-size: 28px;
            font-weight: bold;
            color: #27ae60;
        }

        .actions {
            margin-top: 30px;
            display: flex;
            justify-content: flex-end;
            gap: 15px; /* Espace entre les boutons */
        }

        .action-btn {
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #print-receipt {
            background-color: #3498db;
            color: white;
        }
        #print-receipt:hover {
            background-color: #2980b9;
        }

        #new-sale {
            background-color: #f39c12;
            color: white;
        }
        #new-sale:hover {
            background-color: #e67e22;
        }
        
        /* Styles pour l'impression */
        @media print {
            body {
                background-color: #fff;
                padding: 0;
                font-size: 12pt;
            }
            .container {
                box-shadow: none;
                border: none;
                width: 100%;
                max-width: 100%;
                padding: 0;
            }
            .no-print { /* Classe pour masquer les éléments non désirés */
                display: none;
            }
            .receipt-table th, .receipt-table td {
                padding: 8px;
            }
            #total-price {
                font-size: 20pt;
            }
            h1 {
                text-align: center;
            }
        }
        
        .print-header {
            display: none; /* Masqué par défaut */
        }

        @media print {
            .print-header {
                display: block; /* Visible à l'impression */
                text-align: center;
                margin-bottom: 20px;
            }
        }

    </style>
</head>
<body>

    <div class="container">
        <!-- En-tête visible uniquement à l'impression -->
        <div class="print-header">
            <h3>Merci de votre achat !</h3>
            <p>Date : <span id="print-date"></span></p>
        </div>

        <h1 class="no-print">Système de Caisse</h1>

        <!-- Section de recherche de produits -->
        <div class="search-section no-print">
            <label for="product-search">Chercher un produit</label>
            <input type="text" id="product-search" placeholder="Tapez le nom d'un produit...">
            <div id="search-results"></div>
        </div>

        <!-- Section du reçu -->
        <h2>Reçu Client</h2>
        <table class="receipt-table">
            <thead>
                <tr>
                    <th>Produit</th>
                    <th class="price">Prix Unitaire</th>
                    <th class="price">Quantité</th>
                    <th class="price">Sous-total</th>
                    <th class="no-print">Action</th>
                </tr>
            </thead>
            <tbody id="receipt-items">
                <!-- Les produits ajoutés apparaîtront ici -->
            </tbody>
        </table>

        <!-- Section du total -->
        <div class="total-section">
            <h2>Total à Payer</h2>
            <div id="total-price">0.00 €</div>
        </div>
        
        <!-- Boutons d'action -->
        <div class="actions no-print">
            <button id="new-sale" class="action-btn">Nouvelle Vente</button>
            <button id="print-receipt" class="action-btn">Imprimer le reçu</button>
        </div>

    </div>

    <script>
        // --- BASE DE DONNÉES DES PRODUITS ---
        // Vous pouvez ajouter, modifier ou supprimer des produits ici
        const products = [
            { id: 1, name: "Pomme Gala", price: 0.50 },
            { id: 2, name: "Banane", price: 0.30 },
            { id: 3, name: "Pain de campagne (500g)", price: 2.20 },
            { id: 4, name: "Lait (1L)", price: 1.10 },
            { id: 5, name: "Fromage de chèvre", price: 3.50 },
            { id: 6, name: "Jus d'orange (1L)", price: 2.80 },
            { id: 7, name: "Yaourt Nature (x4)", price: 1.90 },
            { id: 8, name: "Tomates (kg)", price: 3.00 },
            { id: 9, name: "Poulet fermier (kg)", price: 12.50 },
            { id: 10, name: "Savon de Marseille", price: 2.00 },
        ];

        // --- ÉLÉMENTS DU DOM ---
        const searchInput = document.getElementById('product-search');
        const searchResults = document.getElementById('search-results');
        const receiptItems = document.getElementById('receipt-items');
        const totalPriceEl = document.getElementById('total-price');
        const printBtn = document.getElementById('print-receipt');
        const newSaleBtn = document.getElementById('new-sale');
        const printDateEl = document.getElementById('print-date');

        // --- ÉTAT DE L'APPLICATION ---
        let currentReceipt = []; // contiendra les produits du reçu actuel

        // --- FONCTIONS ---

        /**
         * Affiche les résultats de recherche dans le DOM
         */
        function displaySearchResults(results) {
            searchResults.innerHTML = ''; // Vide les anciens résultats
            if (results.length > 0) {
                results.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'result-item';
                    item.textContent = `${product.name} - ${product.price.toFixed(2)} €`;
                    item.dataset.productId = product.id; // Stocke l'ID du produit
                    item.addEventListener('click', () => addProductToReceipt(product.id));
                    searchResults.appendChild(item);
                });
            }
        }
        
        /**
         * Ajoute un produit au reçu ou incrémente sa quantité
         */
        function addProductToReceipt(productId) {
            const product = products.find(p => p.id === productId);
            const existingProduct = currentReceipt.find(item => item.id === productId);

            if (existingProduct) {
                existingProduct.quantity++; // Incrémente la quantité
            } else {
                currentReceipt.push({ ...product, quantity: 1 }); // Ajoute le produit au reçu
            }
            
            // Réinitialise la recherche et met à jour l'affichage
            searchInput.value = '';
            searchResults.innerHTML = '';
            renderReceipt();
        }

        /**
         * Supprime un produit du reçu
         */
        function removeProductFromReceipt(productId) {
            // Filtre le tableau pour enlever le produit avec l'ID correspondant
            currentReceipt = currentReceipt.filter(item => item.id !== productId);
            renderReceipt();
        }

        /**
         * Met à jour l'affichage complet du reçu et du total
         */
        function renderReceipt() {
            receiptItems.innerHTML = ''; // Vide le tableau
            let total = 0;

            currentReceipt.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td class="price">${item.price.toFixed(2)} €</td>
                    <td class="price">${item.quantity}</td>
                    <td class="price">${subtotal.toFixed(2)} €</td>
                    <td class="no-print"><button class="delete-btn" data-product-id="${item.id}">X</button></td>
                `;
                receiptItems.appendChild(row);
            });
            
            // Met à jour le total
            totalPriceEl.textContent = `${total.toFixed(2)} €`;

            // Ajoute les écouteurs pour les boutons de suppression
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const productId = parseInt(e.target.dataset.productId, 10);
                    removeProductFromReceipt(productId);
                });
            });
        }
        
        /**
         * Réinitialise la vente
         */
        function startNewSale() {
            currentReceipt = [];
            searchInput.value = '';
            searchResults.innerHTML = '';
            renderReceipt();
        }


        // --- ÉCOUTEURS D'ÉVÉNEMENTS ---

        // Événement sur la barre de recherche
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            if (query.length === 0) {
                searchResults.innerHTML = '';
                return;
            }
            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(query));
            displaySearchResults(filteredProducts);
        });

        // Événement pour le bouton d'impression
        printBtn.addEventListener('click', () => {
            if (currentReceipt.length > 0) {
                // Met à jour la date avant d'imprimer
                printDateEl.textContent = new Date().toLocaleDateString('fr-FR');
                window.print();
            } else {
                alert("Le reçu est vide. Ajoutez des produits avant d'imprimer.");
            }
        });
        
        // Événement pour le bouton "Nouvelle Vente"
        newSaleBtn.addEventListener('click', startNewSale);
        
        // Initialisation de la page
        renderReceipt();

    </script>
</body>
</html>
{% endblock %}


