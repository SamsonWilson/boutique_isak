{% extends "base.html" %}
{% load static %}

{% block title %}Nouvelle Vente - Gestion multi-boutiques{% endblock %}

{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports des Ventes</title>
    <style>
        /* Styles similaires aux autres pages */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; background-color: #f0f2f5; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background-color: #ffffff; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1); }
        h1, h2 { color: #1c2e4a; border-bottom: 2px solid #e1e4e8; padding-bottom: 10px; }
        .nav-link { display: inline-block; margin-bottom: 20px; padding: 10px 15px; background-color: #3498db; color: white; text-decoration: none; border-radius: 5px; font-weight: 600; }
        .filter-section { background-color: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 30px; display: flex; gap: 20px; align-items: center; flex-wrap: wrap; }
        .filter-section label { font-weight: 600; }
        .filter-section input[type="date"] { padding: 8px; border-radius: 5px; border: 1px solid #ccc; }
        .filter-section button { padding: 10px 20px; border: none; border-radius: 6px; cursor: pointer; background-color: #27ae60; color: white; font-weight: 600; }
        .summary-section { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .summary-card { background: #ecf0f1; padding: 20px; border-radius: 8px; text-align: center; }
        .summary-card .value { font-size: 2rem; font-weight: bold; color: #2c3e50; }
        .summary-card .label { font-size: 1rem; color: #7f8c8d; }
        .report-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .report-table th, .report-table td { padding: 12px; text-align: left; border-bottom: 1px solid #e1e4e8; }
        .report-table th { background-color: #f8f9fa; }
        .num { text-align: right; }
    </style>
</head>
<body>
    <div class="container">
        <a href="caisse.html" class="nav-link">← Retour à la Caisse</a>
        <h1>Rapports des Ventes</h1>

        <div class="filter-section">
            <label for="date-start">Du :</label>
            <input type="date" id="date-start">
            <label for="date-end">Au :</label>
            <input type="date" id="date-end">
            <button id="generate-report-btn">Générer le rapport</button>
        </div>

        <h2>Résumé de la période</h2>
        <div class="summary-section">
            <div class="summary-card">
                <div id="summary-revenue" class="value">0.00 €</div>
                <div class="label">Revenu Total</div>
            </div>
            <div class="summary-card">
                <div id="summary-items-sold" class="value">0</div>
                <div class="label">Articles Vendus</div>
            </div>
        </div>

        <h2>Détail par produit</h2>
        <table class="report-table">
            <thead>
                <tr>
                    <th>Produit</th>
                    <th class="num">Stock Initial</th>
                    <th class="num">Qté Vendue</th>
                    <th class="num">Stock Final</th>
                    <th class="num">Revenu du Produit</th>
                </tr>
            </thead>
            <tbody id="report-body">
                <!-- Les données du rapport seront injectées ici -->
            </tbody>
        </table>
    </div>

<script>
    const PRODUCTS_STORAGE_KEY = 'mes-produits';
    const SALES_HISTORY_KEY = 'historique-ventes';

    // Récupération des données depuis localStorage
    const allProducts = JSON.parse(localStorage.getItem(PRODUCTS_STORAGE_KEY) || '[]');
    const salesHistory = JSON.parse(localStorage.getItem(SALES_HISTORY_KEY) || '[]');

    // Éléments du DOM
    const dateStartInput = document.getElementById('date-start');
    const dateEndInput = document.getElementById('date-end');
    const generateBtn = document.getElementById('generate-report-btn');
    const reportBody = document.getElementById('report-body');
    const summaryRevenueEl = document.getElementById('summary-revenue');
    const summaryItemsSoldEl = document.getElementById('summary-items-sold');

    function generateReport() {
        const startDate = new Date(dateStartInput.value);
        // Pour inclure toute la journée de fin, on met l'heure à 23:59:59
        const endDate = new Date(dateEndInput.value);
        endDate.setHours(23, 59, 59, 999);

        if (!dateStartInput.value || !dateEndInput.value) {
            alert("Veuillez sélectionner une date de début et de fin.");
            return;
        }

        // 1. Filtrer l'historique des ventes pour la période sélectionnée
        const filteredSales = salesHistory.filter(sale => {
            const saleDate = new Date(sale.date);
            return saleDate >= startDate && saleDate <= endDate;
        });

        // 2. Agréger les données par produit
        const productSummary = {};
        filteredSales.forEach(sale => {
            sale.items.forEach(item => {
                if (!productSummary[item.id]) {
                    productSummary[item.id] = {
                        id: item.id,
                        name: item.name,
                        qteVendue: 0,
                        revenu: 0
                    };
                }
                productSummary[item.id].qteVendue += item.quantity;
                productSummary[item.id].revenu += item.price * item.quantity;
            });
        });

        // 3. Calculer les stocks et générer le tableau
        reportBody.innerHTML = '';
        let totalRevenue = 0;
        let totalItemsSold = 0;

        Object.values(productSummary).forEach(summary => {
            const currentProduct = allProducts.find(p => p.id === summary.id);
            const stockFinal = currentProduct ? currentProduct.stock : 0;
            const stockInitial = stockFinal + summary.qteVendue;
            
            totalRevenue += summary.revenu;
            totalItemsSold += summary.qteVendue;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${summary.name} ${!currentProduct ? '(Supprimé)' : ''}</td>
                <td class="num">${stockInitial}</td>
                <td class="num">${summary.qteVendue}</td>
                <td class="num">${stockFinal}</td>
                <td class="num">${summary.revenu.toFixed(2)} €</td>
            `;
            reportBody.appendChild(row);
        });

        // 4. Mettre à jour les cartes de résumé
        summaryRevenueEl.textContent = `${totalRevenue.toFixed(2)} €`;
        summaryItemsSoldEl.textContent = totalItemsSold;

        if (Object.keys(productSummary).length === 0) {
            reportBody.innerHTML = `<tr><td colspan="5" style="text-align:center;">Aucune vente pour cette période.</td></tr>`;
        }
    }

    // Initialisation
    generateBtn.addEventListener('click', generateReport);
    
    // Mettre des dates par défaut (le mois en cours)
    const today = new Date();
    const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
    dateStartInput.value = firstDayOfMonth.toISOString().split('T')[0];
    dateEndInput.value = today.toISOString().split('T')[0];
    
    // Générer un premier rapport au chargement
    generateReport();
</script>
</body>
</html>
{% endblock %}
