{% comment %} 
<div class="container mt-4">
    <h2>Mettre à jour le stock</h2>

    <form method="post" action="{% url 'stock_edit' stock.id %}">
        {% if form.non_field_errors %}
            <div class="alert alert-danger">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">{{ message }}</div>
            {% endfor %}
        {% endif %}

        {% if form.errors %}
            <div class="alert alert-danger">
                <strong>Veuillez corriger les erreurs suivantes :</strong>
                <ul>
                    {% for field in form %}
                        {% for error in field.errors %}
                            <li>{{ error }}</li>
                        {% endfor %}
                    {% endfor %}
                </ul>
            </div>
        {% endif %}
        {% csrf_token %}
        {{ form.non_field_errors }}
        {% for field in form %}
            <div class="mb-3">
                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                {{ field }}
                {% if field.help_text %}
                <div class="form-text">{{ field.help_text }}</div>
                {% endif %}
                {% for error in field.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>
        {% endfor %}
        <button type="submit" class="btn btn-success">Enregistrer</button>
        <a href="{% url 'stock_list' %}" class="btn btn-secondary">Annuler</a>
    </form>
</div> {% endcomment %}
<!-- votre_app/templates/votre_app/stock_edit_template.html -->

<!-- Fichier : votre_app/templates/votre_app/stock_edit.html -->
<!-- stocks/stock_Update_form.html -->
{% comment %} Le code que vous avez fourni est déjà bon et fonctionnera avec la nouvelle vue. {% endcomment %}
<!-- ======================= CORRECTION FINALE ======================= -->

<div class="container mt-4">
    <h2>Mettre à jour le stock pour : {{ stock.produit.nom }}</h2>
    <!-- L'attribut action="" est plus propre pour une UpdateView,
         car elle gère l'URL elle-même. -->
    <form method="post" action="{% url 'stock_edit' stock.id %}">
        {% csrf_token %}

        <!-- Affichage des messages et erreurs globales (inchangé) -->
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            {% endfor %}
        {% endif %}

        {% if form.non_field_errors %}
            <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="card p-3 mb-4">
            <h5 class="card-title">Gestion de la quantité</h5>
            
            <div class="mb-3">
                <label for="stock_initial" class="form-label">Stock Actuel</label>
                <input type="number" id="stock_initial" class="form-control" value="{{ stock.quantite }}" readonly>
            </div>

            <div class="mb-3">
                <label for="{{ form.quantite_a_ajouter.id_for_label }}" class="form-label">{{ form.quantite_a_ajouter.label }}</label>
                
                <!-- Cette ligne génère l'<input> qui a DÉJÀ le bon id="id_quantite_a_ajouter" -->
                {{ form.quantite_a_ajouter }}
                
                {% if form.quantite_a_ajouter.help_text %}
                  <!-- CORRECTION : On a retiré l'attribut 'id' de cette div -->
                  <div class="form-text">{{ form.quantite_a_ajouter.help_text }}</div>
                {% endif %}
                {% for error in form.quantite_a_ajouter.errors %}
                    <div class="text-danger">{{ error }}</div>
                {% endfor %}
            </div>

            {% comment %} <div class="mb-3">
                <label for="nouveau_stock" class="form-label">Nouveau Stock (calculé)</label>
                <input type="number" id="nouveau_stock" class="form-control" readonly>
            </div> {% endcomment %}
            <div class="mb-3">
    <label for="nouveau_stock" class="form-label">
        Nouveau Stock (prévisionnel avant sauvegarde)
    </label>
    <input type="number" id="nouveau_stock"
           class="form-control"
           value="{{ stock.quantite }}"
           readonly>
    <div class="form-text text-warning">
        Ce calcul est automatique et ne sera effectif qu'après enregistrement.
    </div>
</div>
        </div>

        <button type="submit" class="btn btn-success">Enregistrer</button>
        <a href="{% url 'stock_list' %}" class="btn btn-secondary">Annuler</a>
    </form>
</div>

<!-- VOTRE JAVASCRIPT EST DÉJÀ PARFAIT ET N'A PAS BESOIN D'ÊTRE MODIFIÉ -->
<script>
document.addEventListener('DOMContentLoaded', function () {

    // --- Fonction réutilisable pour le calcul automatique du stock ---
    function initCalculStock() {
        const stockInitialEl = document.getElementById('stock_initial');
        const quantiteAjouterEl = document.getElementById('id_quantite_a_ajouter');
        const nouveauStockEl = document.getElementById('nouveau_stock');

        if (!stockInitialEl || !quantiteAjouterEl || !nouveauStockEl) {
            // Ce formulaire n’est pas un formulaire de stock → on sort
            return;
        }

        function calculerNouveauStock() {
            const stockInitial = parseInt(stockInitialEl.value, 10) || 0;
            const quantiteAjouter = parseInt(quantiteAjouterEl.value, 10) || 0;
            nouveauStockEl.value = stockInitial + quantiteAjouter;
        }

        quantiteAjouterEl.addEventListener('input', calculerNouveauStock);
        calculerNouveauStock(); // Calcul initial
    }

    // --- Gestion de la modale générique ---
    const modal = document.getElementById('main-modal');
    const modalBody = document.getElementById('modal-body');
    const closeModalBtn = modal.querySelector('.close-button');

    const openModal = (url) => {
        modal.style.display = 'block';
        modalBody.innerHTML = '<p style="text-align:center;">Chargement...</p>';

        fetch(url)
            .then(response => {
                if (!response.ok) throw new Error('Erreur réseau.');
                return response.text();
            })
            .then(html => {
                modalBody.innerHTML = html;

                // Initialise le calcul automatique si c'est un formulaire stock
                initCalculStock();

                // Attache l'événement de soumission du formulaire
                const form = modalBody.querySelector('form');
                if (form) {
                    form.addEventListener('submit', handleFormSubmit);
                }
            })
            .catch(error => {
                modalBody.innerHTML = `<p style="color:red; text-align:center;">Erreur: Impossible de charger le contenu.</p>`;
                console.error('Erreur Fetch pour la modale:', error);
            });
    };

    const closeModal = () => {
        modal.style.display = 'none';
        modalBody.innerHTML = '';
    };

    const handleFormSubmit = (event) => {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    closeModal();
                    location.reload();
                } else {
                    modalBody.innerHTML = data.form_html;

                    // Réinitialise le calcul automatique après une erreur
                    initCalculStock();

                    // Réattache l'écouteur sur le formulaire rechargé
                    const newForm = modalBody.querySelector('form');
                    if (newForm) {
                        newForm.addEventListener('submit', handleFormSubmit);
                    }
                }
            })
            .catch(error => console.error('Erreur de soumission du formulaire:', error));
    };

    // --- Attacher les événements ---
    document.querySelectorAll('.js-open-modal').forEach(trigger => {
        trigger.addEventListener('click', function (event) {
            event.preventDefault();
            const url = this.dataset.url;
            openModal(url);
        });
    });

    // Suppression d'un élément
    document.querySelectorAll('.js-delete-item').forEach(trigger => {
        trigger.addEventListener('click', function (event) {
            event.preventDefault();
            const url = this.dataset.url;
            const confirmation = confirm("Êtes-vous sûr de vouloir supprimer cet élément ?");

            if (confirmation) {
                const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrfToken,
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            location.reload();
                        } else {
                            alert("Erreur lors de la suppression.");
                        }
                    })
                    .catch(error => console.error('Erreur de suppression:', error));
            }
        });
    });

    // Fermeture de la modale
    closeModalBtn.addEventListener('click', closeModal);
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });

    // Calcul automatique si le formulaire est sur la page directement
    initCalculStock();
});
</script>
{% comment %} <script>
document.addEventListener('DOMContentLoaded', function() {
    const stockInitialEl = document.getElementById('stock_initial');
    // Ce code va maintenant trouver le bon <input> et non plus la <div>
    const quantiteAjouterEl = document.getElementById('id_quantite_a_ajouter');
    const nouveauStockEl = document.getElementById('nouveau_stock');

    function calculerNouveauStock() {
        const stockInitial = parseInt(stockInitialEl.value, 10) || 0;
        const quantiteAjouter = parseInt(quantiteAjouterEl.value, 10) || 0;
        const nouveauStock = stockInitial + quantiteAjouter;
        nouveauStockEl.value = nouveauStock;
    }
    
    // On s'assure que quantiteAjouterEl n'est pas null avant d'ajouter l'écouteur
    if (quantiteAjouterEl) {
        quantiteAjouterEl.addEventListener('input', calculerNouveauStock);
        // On calcule une première fois au chargement
        calculerNouveauStock();
    } else {
        console.error("L'élément avec l'ID 'id_quantite_a_ajouter' n'a pas été trouvé !");
    }
});
</script> {% endcomment %}