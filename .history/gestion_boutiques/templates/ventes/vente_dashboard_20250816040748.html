 {% extends "base.html" %}
{% load static %}
{% block title %}Tableau de Bord - Gestion multi-boutiques{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Caisse - Modale de Quantit√©</title>
    
</head>
<body>
  
            <h5 class="mt-3">üë§ Informations du Client</h5>
                        <div class="row mb-3">
                            <div class="col-md-4">
                                {{ form.nom.label_tag }}
                                {{ form.nom }}
                            </div>
                            <div class="col-md-4">
                                {{ form.contact.label_tag }}
                                {{ form.contact }}
                            </div>
                            <div class="col-md-4">
                                {{ form.adresse.label_tag }}
                                {{ form.adresse }}
                            </div>
                        </div>
            <!-- Structure de la Modale -->
            <div id="quantity-modal" class="modal-overlay">
                <div class="modal-content">
                    <div class="modal-header">
                        <h3 id="modal-product-name"></h3>
                    </div>
                    <div class="modal-body">
                        <label for="modal-quantity-input">Quantit√©</label>
                        <input type="number" id="modal-quantity-input" min="1" value="1">
                    </div>
                    <div class="modal-footer">
                        <button id="modal-cancel-btn" class="modal-btn btn-secondary">Annuler</button>
                        <button id="modal-confirm-btn" class="modal-btn btn-primary">Ajouter</button>
                    </div>
                </div>
            </div>
            <!-- Fin de la Modale -->

            <div class="container">
                <div class="print-header">
                    <h3>Merci de votre achat !</h3>
                    <p>Date : <span id="print-date"></span></p>
                </div>

                <h1 class="no-print">Syst√®me de Caisse</h1>

                <div class="search-section no-print">
                    <label for="product-search">Chercher un produit</label>
                    <input type="text" id="product-search" placeholder="Tapez le nom d'un produit...">
                    <div id="search-results"></div>
                </div>

                <h2>Re√ßu Client</h2>
                <table class="receipt-table">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th class="price">Prix Unitaire</th>
                            <th class="quantity">Quantit√©</th>
                            <th class="price">Sous-total</th>
                            <th class="no-print">Action</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items"></tbody>
                </table>

                <div class="total-section">
                    <h2>Total √† Payer</h2>
                    <div id="total-price">0.00 ‚Ç¨</div>
                </div>
                
                <div class="actions no-print">
                    <button id="new-sale" class="action-btn">Nouvelle Vente</button>
                    <button id="print-receipt" class="action-btn">Imprimer le re√ßu</button>
                </div>
            </div>
        </form>

<script>
    // --- VARIABLES ET DOM ---
    const searchInput = document.getElementById('product-search');
    const searchResults = document.getElementById('search-results');
    const receiptItems = document.getElementById('receipt-items');
    const totalPriceEl = document.getElementById('total-price');
    const printBtn = document.getElementById('print-receipt');
    const newSaleBtn = document.getElementById('new-sale');
    const printDateEl = document.getElementById('print-date');
    
    const modal = document.getElementById('quantity-modal');
    const modalProductName = document.getElementById('modal-product-name');
    const modalQuantityInput = document.getElementById('modal-quantity-input');
    const modalConfirmBtn = document.getElementById('modal-confirm-btn');
    const modalCancelBtn = document.getElementById('modal-cancel-btn');

    let currentReceipt = [];
    let productForModal = null;

    // URL de recherche Django
    const searchUrl = "{% url 'search_product' %}";
    
    // --- FONCTIONS ---
    function showQuantityModal(product) {
        productForModal = product;
        modalProductName.textContent = product.name;
        modalQuantityInput.value = "1";
        modal.classList.add('active');
        modalQuantityInput.focus();
        modalQuantityInput.select();
    }

    function hideQuantityModal() {
        modal.classList.remove('active');
        productForModal = null;
    }

    function handleConfirmQuantity() {
        const quantity = parseInt(modalQuantityInput.value, 10);

        if (!productForModal || isNaN(quantity) || quantity <= 0) {
            alert("Veuillez entrer une quantit√© valide.");
            return;
        }

        const existingItem = currentReceipt.find(item => item.id === productForModal.id);

        if (existingItem) {
            existingItem.quantity += quantity;
        } else {
            currentReceipt.push({ ...productForModal, quantity: quantity });
        }

        searchInput.value = '';
        searchResults.innerHTML = '';
        renderReceipt();
        hideQuantityModal();
    }

    function displaySearchResults(results) {
        searchResults.innerHTML = '';
        results.forEach(product => {
            const item = document.createElement('div');
            item.className = 'result-item';

            // Couleur stock
            let stockColor = "orange";
            if (product.quantityStock > 20) stockColor = "green";
            else if (product.quantityStock < 5) stockColor = "red";

            item.innerHTML = `${product.name} - ${product.price.toFixed(2)} ‚Ç¨ 
                <span style="color:${stockColor}; font-weight:bold;">
                    (Stock: ${product.quantityStock})
                </span>`;

            item.addEventListener('click', () => {
                showQuantityModal(product);
            });
            searchResults.appendChild(item);
        });
    }

    function removeProductFromReceipt(productId) {
        currentReceipt = currentReceipt.filter(item => item.id !== productId);
        renderReceipt();
    }

    function renderReceipt() {
        receiptItems.innerHTML = '';
        let total = 0;

        currentReceipt.forEach(item => {
            const subtotal = item.price * item.quantity;
            total += subtotal;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${item.name}</td>
                <td class="price">${item.price.toFixed(2)} ‚Ç¨</td>
                <td class="quantity">${item.quantity}</td>
                <td class="price">${subtotal.toFixed(2)} ‚Ç¨</td>
                <td class="no-print"><button class="delete-btn" data-product-id="${item.id}">X</button></td>
            `;
            receiptItems.appendChild(row);
        });
        
        totalPriceEl.textContent = `${total.toFixed(2)} ‚Ç¨`;

        document.querySelectorAll('.delete-btn').forEach(button => {
            button.addEventListener('click', (e) => {
                removeProductFromReceipt(parseInt(e.target.dataset.productId, 10));
            });
        });
    }

    function startNewSale() {
        if (currentReceipt.length > 0 && !confirm("√ätes-vous s√ªr de vouloir commencer une nouvelle vente ?")) {
            return;
        }
        currentReceipt = [];
        searchInput.value = '';
        searchResults.innerHTML = '';
        renderReceipt();
    }

    // --- √âCOUTEURS D'√âV√âNEMENTS ---

    // Recherche Ajax
    searchInput.addEventListener('input', () => {
        const query = searchInput.value.trim();
        if (query.length === 0) {
            searchResults.innerHTML = '';
            return;
        }

        fetch(`${searchUrl}?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => displaySearchResults(data))
            .catch(err => console.error("Erreur recherche:", err));
    });

    // Actions modale
    modalConfirmBtn.addEventListener('click', handleConfirmQuantity);
    modalCancelBtn.addEventListener('click', hideQuantityModal);
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideQuantityModal();
        }
    });
    modalQuantityInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') handleConfirmQuantity();
        else if (e.key === 'Escape') hideQuantityModal();
    });
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && modal.classList.contains('active')) {
            hideQuantityModal();
        }
    });

    // Boutons principaux
    printBtn.addEventListener('click', () => {
        if (currentReceipt.length > 0) {
            printDateEl.textContent = new Date().toLocaleDateString('fr-FR');
            window.print();
        } else {
            alert("‚ö†Ô∏è Aucun produit dans le re√ßu");
        }
    });
    
    newSaleBtn.addEventListener('click', startNewSale);

    // Initialisation
    renderReceipt();
</script>

</body>
</html>
{% endblock %}







