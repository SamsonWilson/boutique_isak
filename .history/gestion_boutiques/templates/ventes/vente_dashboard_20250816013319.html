{% extends "base.html" %}

{% load static %}
{% block content %}
{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nouvelle Vente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4>üõí Nouvelle Vente</h4>
        </div>
        <div class="card-body">
            <form method="POST">
                {% csrf_token %}

                <!-- Client -->
                <h5 class="mt-3">üë§ Informations du Client</h5>
                <div class="row mb-3">
                    <div class="col-md-4">{{ client_form.nom.label_tag }} {{ client_form.nom }}</div>
                    <div class="col-md-4">{{ client_form.contact.label_tag }} {{ client_form.contact }}</div>
                    <div class="col-md-4">{{ client_form.adresse.label_tag }} {{ client_form.adresse }}</div>
                </div>

                <hr>

                <!-- Vente -->
                <h5 class="mt-3">üìÑ Informations de Vente</h5>
                <div class="row mb-3">
                    <div class="col-md-3">{{ vente_form.total.label_tag }} {{ vente_form.total }}</div>
                </div>

                <hr>

                <!-- D√©tails -->
                <h5 class="mt-3">üì¶ Produits Vendus</h5>
                {{ formset.management_form }}
                <table class="table table-bordered align-middle" id="details-table">
                    <thead class="table-light">
                        <tr>
                            <th>Produit</th>
                            <th>Quantit√©</th>
                            <th>Prix Unitaire</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for form in formset %}
                        <tr class="detail-form">
                            <td>{{ form.produit }}</td>
                            <td>{{ form.quantite }}</td>
                            <td>{{ form.prix_unitaire }}</td>
                            <td>
                                <button type="button" class="btn btn-danger btn-sm remove-form">üóëÔ∏è</button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <!-- Bouton ajouter -->
                <button type="button" class="btn btn-primary mb-3" id="add-form">‚ûï Ajouter un produit</button>

                <br>
                <button type="submit" class="btn btn-success">
                    üíæ Enregistrer la Vente
                </button>
                {% comment %} <a href="{% url 'home' %}" class="btn btn-secondary">‚ùå Annuler</a> {% endcomment %}
            </form>
        </div>
    </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
    let totalForms = document.getElementById("id_details-TOTAL_FORMS");
    let formContainer = document.querySelector("#details-table tbody");
    let addButton = document.getElementById("add-form");

    addButton.addEventListener("click", function() {
        let currentForms = document.querySelectorAll(".detail-form");
        let formNum = currentForms.length;

        // Clone le premier form
        let newForm = currentForms[0].cloneNode(true);
        let regex = new RegExp(`details-(\\d+)`, "g");

        newForm.innerHTML = newForm.innerHTML.replace(regex, `details-${formNum}`);

        // Vider les valeurs des champs
        newForm.querySelectorAll("input, select").forEach(el => {
            if (el.type !== "hidden") el.value = "";
        });

        formContainer.appendChild(newForm);

        // Met √† jour le management_form
        totalForms.value = formNum + 1;
    });

    // suppression d‚Äôun formulaire
    formContainer.addEventListener("click", function(e) {
        if (e.target.classList.contains("remove-form")) {
            let forms = document.querySelectorAll(".detail-form");
            if (forms.length > 1) {
                e.target.closest(".detail-form").remove();
                totalForms.value = forms.length - 1;
            } else {
                alert("‚ö†Ô∏è Il doit rester au moins un produit !");
            }
        }
    });
});
</script>
</body>
</html>
{% endblock %}
{% comment %} {% load static %}
{% block title %}Tableau de Bord - Gestion multi-boutiques{% endblock %}
{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Syst√®me de Caisse - Modale de Quantit√©</title>
    
</head>
<body>

    <!-- Structure de la Modale -->
    <div id="quantity-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-product-name"></h3>
            </div>
            <div class="modal-body">
                <label for="modal-quantity-input">Quantit√©</label>
                <input type="number" id="modal-quantity-input" min="1" value="1">
            </div>
            <div class="modal-footer">
                <button id="modal-cancel-btn" class="modal-btn btn-secondary">Annuler</button>
                <button id="modal-confirm-btn" class="modal-btn btn-primary">Ajouter</button>
            </div>
        </div>
    </div>
    <!-- Fin de la Modale -->

    <div class="container">
        <div class="print-header">
            <h3>Merci de votre achat !</h3>
            <p>Date : <span id="print-date"></span></p>
        </div>

        <h1 class="no-print">Syst√®me de Caisse</h1>

        <div class="search-section no-print">
            <label for="product-search">Chercher un produit</label>
            <input type="text" id="product-search" placeholder="Tapez le nom d'un produit...">
            <div id="search-results"></div>
        </div>

        <h2>Re√ßu Client</h2>
        <table class="receipt-table">
            <thead>
                <tr>
                    <th>Produit</th>
                    <th class="price">Prix Unitaire</th>
                    <th class="quantity">Quantit√©</th>
                    <th class="price">Sous-total</th>
                    <th class="no-print">Action</th>
                </tr>
            </thead>
            <tbody id="receipt-items"></tbody>
        </table>

        <div class="total-section">
            <h2>Total √† Payer</h2>
            <div id="total-price">0.00 ‚Ç¨</div>
        </div>
        
        <div class="actions no-print">
            <button id="new-sale" class="action-btn">Nouvelle Vente</button>
            <button id="print-receipt" class="action-btn">Imprimer le re√ßu</button>
        </div>
    </div>

    <script>
        // --- BASE DE DONN√âES DES PRODUITS ---
        const products = [
            { id: 1, name: "Pomme Gala", price: 0.50 },
            { id: 2, name: "Banane", price: 0.30 },
            { id: 3, name: "Pain de campagne (500g)", price: 2.20 },
            { id: 4, name: "Lait (1L)", price: 1.10 },
            { id: 5, name: "Fromage de ch√®vre", price: 3.50 },
            { id: 6, name: "Jus d'orange (1L)", price: 2.80 },
            { id: 7, name: "Yaourt Nature (x4)", price: 1.90 },
            { id: 8, name: "Tomates (kg)", price: 3.00 },
            { id: 9, name: "Poulet fermier (kg)", price: 12.50 },
            { id: 10, name: "Savon de Marseille", price: 2.00 },
        ];

        // --- √âL√âMENTS DU DOM ---
        const searchInput = document.getElementById('product-search');
        const searchResults = document.getElementById('search-results');
        const receiptItems = document.getElementById('receipt-items');
        const totalPriceEl = document.getElementById('total-price');
        const printBtn = document.getElementById('print-receipt');
        const newSaleBtn = document.getElementById('new-sale');
        const printDateEl = document.getElementById('print-date');
        
        // --- √âL√âMENTS DE LA MODALE ---
        const modal = document.getElementById('quantity-modal');
        const modalProductName = document.getElementById('modal-product-name');
        const modalQuantityInput = document.getElementById('modal-quantity-input');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- √âTAT DE L'APPLICATION ---
        let currentReceipt = [];
        let productForModal = null; // Stocke temporairement le produit √† ajouter

        // --- FONCTIONS ---

        /**
         * Affiche la modale de quantit√© pour un produit donn√©
         */
        function showQuantityModal(product) {
            productForModal = product;
            modalProductName.textContent = product.name;
            modalQuantityInput.value = "1";
            modal.classList.add('active');
            modalQuantityInput.focus(); // Met le curseur dans le champ
            modalQuantityInput.select(); // S√©lectionne le texte pour le remplacer facilement
        }

        /**
         * Cache la modale de quantit√©
         */
        function hideQuantityModal() {
            modal.classList.remove('active');
            productForModal = null;
        }

        /**
         * G√®re la confirmation de la quantit√© depuis la modale
         */
        function handleConfirmQuantity() {
            const quantity = parseInt(modalQuantityInput.value, 10);

            if (!productForModal || isNaN(quantity) || quantity <= 0) {
                alert("Veuillez entrer une quantit√© valide.");
                return;
            }

            const existingItem = currentReceipt.find(item => item.id === productForModal.id);

            if (existingItem) {
                existingItem.quantity += quantity;
            } else {
                currentReceipt.push({ ...productForModal, quantity: quantity });
            }

            searchInput.value = '';
            searchResults.innerHTML = '';
            renderReceipt();
            hideQuantityModal();
        }

        /**
         * Affiche les r√©sultats de la recherche
         */
        function displaySearchResults(results) {
            searchResults.innerHTML = '';
            results.forEach(product => {
                const item = document.createElement('div');
                item.className = 'result-item';
                item.textContent = `${product.name} - ${product.price.toFixed(2)} ‚Ç¨`;
                // Quand on clique, on ne fait qu'ouvrir la modale
                item.addEventListener('click', () => {
                    const selectedProduct = products.find(p => p.id === product.id);
                    if (selectedProduct) {
                        showQuantityModal(selectedProduct);
                    }
                });
                searchResults.appendChild(item);
            });
        }

        /**
         * Supprime un produit du re√ßu
         */
        function removeProductFromReceipt(productId) {
            currentReceipt = currentReceipt.filter(item => item.id !== productId);
            renderReceipt();
        }

        /**
         * Met √† jour l'affichage complet du re√ßu et du total
         */
        function renderReceipt() {
            receiptItems.innerHTML = '';
            let total = 0;

            currentReceipt.forEach(item => {
                const subtotal = item.price * item.quantity;
                total += subtotal;

                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.name}</td>
                    <td class="price">${item.price.toFixed(2)} ‚Ç¨</td>
                    <td class="quantity">${item.quantity}</td>
                    <td class="price">${subtotal.toFixed(2)} ‚Ç¨</td>
                    <td class="no-print"><button class="delete-btn" data-product-id="${item.id}">X</button></td>
                `;
                receiptItems.appendChild(row);
            });
            
            totalPriceEl.textContent = `${total.toFixed(2)} ‚Ç¨`;
            
            // Attacher les √©couteurs pour les boutons de suppression
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    removeProductFromReceipt(parseInt(e.target.dataset.productId, 10));
                });
            });
        }
        
        /**
         * R√©initialise la vente
         */
        function startNewSale() {
            if (currentReceipt.length > 0 && !confirm("√ätes-vous s√ªr de vouloir commencer une nouvelle vente ? Le re√ßu actuel sera effac√©.")) {
                return;
            }
            currentReceipt = [];
            searchInput.value = '';
            searchResults.innerHTML = '';
            renderReceipt();
        }

        // --- √âCOUTEURS D'√âV√âNEMENTS ---

        // Recherche de produit
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.toLowerCase();
            if (query.length === 0) {
                searchResults.innerHTML = '';
                return;
            }
            const filteredProducts = products.filter(p => p.name.toLowerCase().includes(query));
            displaySearchResults(filteredProducts);
        });

        // Actions de la modale
        modalConfirmBtn.addEventListener('click', handleConfirmQuantity);
        modalCancelBtn.addEventListener('click', hideQuantityModal);
        modal.addEventListener('click', (e) => { // Ferme la modale si on clique sur le fond
            if (e.target === modal) {
                hideQuantityModal();
            }
        });
        
        // Raccourcis clavier pour la modale
        modalQuantityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                handleConfirmQuantity();
            } else if (e.key === 'Escape') {
                hideQuantityModal();
            }
        });
        document.addEventListener('keydown', (e) => { // Fermer avec Echap n'importe o√π
             if (e.key === 'Escape' && modal.classList.contains('active')) {
                hideQuantityModal();
            }
        });

        // Boutons principaux
        printBtn.addEventListener('click', () => {
            if (currentReceipt.length > 0) {
                printDateEl.textContent = new Date().toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                window.print();
            } else {
                alert("Le re√ßu est vide. Ajoutez des produits avant d'imprimer.");
            }
        });
        
        newSaleBtn.addEventListener('click', startNewSale);
        
        // Initialisation
        renderReceipt();

    </script>
</body>
</html> {% endcomment %}
{% comment %} {% endblock %} {% endcomment %}


