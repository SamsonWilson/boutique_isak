
{% extends "base.html" %}
{% load static %}

{% block title %}Liste des Produits - Gestion multi-boutiques{% endblock %}

{% block content %}
{# Nous n'avons plus besoin de charger static ici car c'est déjà fait en haut #}
{# Nous n'avons plus besoin des balises <html>, <head>, <body> car elles viennent de "base.html" #}

<style>
    /* Styles de la page (inchangés) */
    body { background: #f6f8fb; font-family: Inter, sans-serif; margin:0; }
    .container { max-width:1400px; margin:30px auto; }
    .card { border-radius:14px; box-shadow:0 2px 20px #dbe6ff80; background:#fff; margin-bottom:28px; padding:22px; }
    .dashboard-grid { display:flex; gap:34px; }
    .col { flex:1; min-width:0;}
    .table-wrapper { overflow:auto; margin-bottom:24px; }
    table { width: 100%; border-collapse:collapse; background:#fff; }
    thead { background: #f1f3f9;}
    th, td { padding: 13px 10px; border-bottom:1px solid #eaeaea;}
    th { font-weight:600; color: #4361ee; }
    tr:hover { background: #f1f6ff;}
    .actions a { margin:0 5px; color: #3b5bdb;}
    .actions a:hover { color: #ff5a36;}

    /* NOUVEAUX STYLES POUR LA FENÊTRE MODALE */
    .modal {
        display: none; /* Cachée par défaut */
        position: fixed; /* Reste en place même si on scrolle */
        z-index: 1000; /* Se place au-dessus de tout le reste */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Permet de scroller si le contenu est trop grand */
        background-color: rgba(0,0,0,0.5); /* Fond noir semi-transparent */
    }

    .modal-content {
        background-color: #fff;
        margin: 10% auto; /* 10% du haut et centré horizontalement */
        padding: 25px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px; /* Largeur maximale */
        border-radius: 14px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        position: relative; /* Pour positionner le bouton de fermeture */
    }

    .close-button {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #4361ee;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary:hover {
        background-color: #3b5bdb;
    }
</style>

<div class="container">
  
    <!-- Tableau Produits -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0; color:#233c59"><i class="fa fa-database"></i> Produits</h2>
            <!-- MODIFICATION : On change le <a> pour un <button> et on lui donne un ID -->
            <button id="open-modal-btn" class="btn-primary">Ajouter un produit</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Description</th>
                    <th>Prix Unitaire (€)</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                    {% for produit in produits %}
                      <tr>
                        <td>{{ produit.nom }}</td>
                        <td>{{ produit.description|truncatechars:32 }}</td>
                        <td>{{ produit.prix_unitaire }}</td>
                        <td class="actions">
                            <a href="{% url 'produit_update' produit.id %}" title="Modifier"><i class="fa fa-edit"></i></a>
                            <a href="{% url 'produit_delete' produit.id %}" title="Supprimer"><i class="fa fa-trash"></i></a>
                        </td>
                      </tr>
                    {% empty %}
                      <tr><td colspan="4" style="text-align:center">Aucun produit</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- =========== LA STRUCTURE DE LA MODALE =========== -->
<div id="product-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">×</span>
    <div id="modal-body">
        <!-- Le contenu du formulaire sera chargé ici par JavaScript -->
        <p>Chargement du formulaire...</p>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // Récupérer les éléments de la modale
    const modal = document.getElementById('product-modal');
    const openBtn = document.getElementById('open-modal-btn');
    const closeBtn = document.querySelector('.close-button');
    const modalBody = document.getElementById('modal-body');

    // URL pour récupérer le formulaire de création
    const createFormUrl = "{% url 'produit_create' %}";

    // Fonction pour ouvrir la modale et charger le formulaire
    const openModal = () => {
        modal.style.display = 'block';
        // Utilise fetch pour récupérer le formulaire depuis la vue Django
        fetch(createFormUrl)
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                // Attacher l'événement de soumission au nouveau formulaire
                const form = modalBody.querySelector('form');
                form.addEventListener('submit', handleFormSubmit);
            })
            .catch(error => {
                modalBody.innerHTML = "<p>Erreur lors du chargement du formulaire.</p>";
                console.error('Error fetching form:', error);
            });
    };

    // Fonction pour fermer la modale
    const closeModal = () => {
        modal.style.display = 'none';
        modalBody.innerHTML = '<p>Chargement du formulaire...</p>'; // Réinitialiser le contenu
    };

    // Gérer la soumission du formulaire via AJAX
    const handleFormSubmit = (event) => {
        event.preventDefault(); // Empêche la soumission classique de la page
        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                // Django a besoin de ce header pour la protection CSRF avec AJAX
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json()) // On attend une réponse JSON du serveur
        .then(data => {
            if (data.success) {
                closeModal();
                location.reload(); // Recharger la page pour voir le nouveau produit
            } else {
                // Si la soumission a échoué (ex: validation), on réaffiche le formulaire avec les erreurs
                modalBody.innerHTML = data.form_html;
                 // Il faut ré-attacher l'événement car le contenu a été remplacé
                const newForm = modalBody.querySelector('form');
                newForm.addEventListener('submit', handleFormSubmit);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            alert("Une erreur s'est produite. Veuillez réessayer.");
        });
    };

    // Événements
    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    // Fermer la modale si l'utilisateur clique en dehors de la boîte de contenu
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });
});
</script>

{% endblock %}
{% comment %} {% extends "base.html" %}
{% load static %}

{% block title %}Nouvelle Vente - Gestion multi-boutiques{% endblock %}

{% block content %}

<h1>Liste des produits</h1>
<a href="{% url 'produit_create' %}">Ajouter un produit</a>
<ul>
  {% for produit in produits %}
    <li>
      <a href="{% url 'produit_detail' produit.pk %}">{{ produit.nom }}</a>
      - {{ produit.prix_unitaire }}€
      <a href="{% url 'produit_update' produit.pk %}">Modifier</a>
      <a href="{% url 'produit_delete' produit.pk %}">Supprimer</a>
    </li>
  {% empty %}
    <li>Aucun produit.</li>
  {% endfor %}
</ul>
{% endblock %} {% endcomment %}
