{% extends "base.html" %}
{% load static %}

{% block title %}Tableau de Bord{% endblock %}
{% block breadcrumb_title %}Tableau de bord{% endblock %}

{% block content %}

<!-- Section 1 : Cartes de Statistiques -->
<div class="row g-4 mb-4">
    <div class="col-md-6 col-xl-3">
        <div class="card stat-card h-100 shadow-sm border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted fw-normal mb-2">Produits Uniques</h6>
                    <h2 class="display-6 fw-bold mb-0">{{ produits.count|default:"0" }}</h2>
                </div>
                <div class="stat-icon bg-primary rounded-circle">
                    <i class="bi bi-box-seam"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card stat-card h-100 shadow-sm border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted fw-normal mb-2">Stocks Enregistrés</h6>
                    <h2 class="display-6 fw-bold mb-0">{{ stocks.count|default:"0" }}</h2>
                </div>
                <div class="stat-icon bg-warning rounded-circle">
                    <i class="bi bi-boxes"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card stat-card h-100 shadow-sm border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted fw-normal mb-2">Total Ventes</h6>
                    <h2 class="display-6 fw-bold mb-0">1,254€</h2>
                </div>
                <div class="stat-icon bg-success rounded-circle">
                    <i class="bi bi-graph-up-arrow"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6 col-xl-3">
        <div class="card stat-card h-100 shadow-sm border-0">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="text-muted fw-normal mb-2">Nouveaux Clients</h6>
                    <h2 class="display-6 fw-bold mb-0">89</h2>
                </div>
                <div class="stat-icon bg-info rounded-circle">
                    <i class="bi bi-person-plus"></i>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Section 2 : Tables de gestion -->
<div class="row g-4">
    <!-- Colonne de gauche : Stocks -->
    <div class="col-lg-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0"><i class="bi bi-boxes me-2"></i>Gestion des Stocks</h5>
                <button class="btn btn-primary btn-sm js-open-modal" data-url="{% url 'stock_add' %}">
                    <i class="bi bi-plus-lg me-1"></i> Ajouter
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Boutique</th><th>Produit</th><th>Quantité</th><th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for stock in stocks %}
                            <tr>
                                <td>{{ stock.boutique }}</td>
                                <td>{{ stock.produit }}</td>
                                <td>{{ stock.quantite }}</td>
                                <td class="text-end">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm js-open-modal" data-url="{% url 'stock_edit' stock.id %}" data-bs-toggle="tooltip" title="Modifier"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-outline-danger btn-sm js-delete-btn" data-url="{% url 'stock_delete' stock.id %}" data-bs-toggle="tooltip" title="Supprimer"><i class="bi bi-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="4" class="text-center text-muted p-5">Aucun stock trouvé.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Colonne de droite : Produits -->
    <div class="col-lg-6">
        <div class="card h-100 shadow-sm border-0">
            <div class="card-header bg-transparent d-flex justify-content-between align-items-center py-3">
                <h5 class="mb-0"><i class="bi bi-box-seam me-2"></i>Catalogue des Produits</h5>
                <button class="btn btn-primary btn-sm js-open-modal" data-url="{% url 'produit_create' %}">
                    <i class="bi bi-plus-lg me-1"></i> Ajouter
                </button>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Nom</th><th>Prix</th><th class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for produit in produits %}
                            <tr>
                                <td>{{ produit.nom }}</td>
                                <td>{{ produit.prix_unitaire }}€</td>
                                <td class="text-end">
                                    <div class="btn-group" role="group">
                                        <button class="btn btn-outline-primary btn-sm js-open-modal" data-url="{% url 'produit_update' produit.id %}" data-bs-toggle="tooltip" title="Modifier"><i class="bi bi-pencil"></i></button>
                                        <button class="btn btn-outline-danger btn-sm js-delete-btn" data-url="{% url 'produit_delete' produit.id %}" data-bs-toggle="tooltip" title="Supprimer"><i class="bi bi-trash"></i></button>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="3" class="text-center text-muted p-5">Aucun produit trouvé.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- =========== Modale Générique pour les Formulaires =========== -->
<div class="modal fade" id="formModal" tabindex="-1" aria-labelledby="formModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" id="modal-content-wrapper">
      <div class="modal-body text-center p-5">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Chargement...</span>
          </div>
      </div>
    </div>
  </div>
</div>

<!-- =========== Modale de Confirmation pour la Suppression =========== -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Confirmer la suppression</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                Êtes-vous sûr ? Cette action est irréversible.
            </div>
            <div class="modal-footer">
                <form id="deleteForm" method="post" action="">
                    {% csrf_token %}
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                    <button type="submit" class="btn btn-danger">Oui, supprimer</button>
                </form>
            </div>
        </div>
    </div>
</div>

{% endblock %}

---

### Étape 3 : JavaScript Amélioré et Simplifié

Le JS précédent était déjà bon, mais on peut le rendre plus robuste et l'adapter à la nouvelle structure.
**Action :** Remplacez le bloc `{% block extra_js %}` dans votre `base.html` (ou créez-le s'il n'existe pas) par ce code.

```javascript
{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    // --- GESTION DES TOOLTIPS ---
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });

    // --- GESTION GÉNÉRIQUE DE LA MODALE DE FORMULAIRE ---
    const formModalEl = document.getElementById('formModal');
    const formModal = new bootstrap.Modal(formModalEl);
    const modalContentWrapper = document.getElementById('modal-content-wrapper');
    const loadingSpinner = `<div class="modal-body text-center p-5"><div class="spinner-border text-primary" role="status"><span class="visually-hidden">Chargement...</span></div></div>`;

    document.querySelectorAll('.js-open-modal').forEach(trigger => {
        trigger.addEventListener('click', function(event) {
            event.preventDefault();
            const url = this.dataset.url;
            modalContentWrapper.innerHTML = loadingSpinner;
            formModal.show();

            fetch(url)
                .then(response => response.text())
                .then(html => {
                    modalContentWrapper.innerHTML = html;
                    const form = modalContentWrapper.querySelector('form');
                    form.addEventListener('submit', handleFormSubmit);
                })
                .catch(error => {
                    modalContentWrapper.innerHTML = '<div class="modal-body"><p>Erreur de chargement.</p></div>';
                    console.error('Modal Fetch Error:', error);
                });
        });
    });
    
    function handleFormSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                formModal.hide();
                location.reload(); // La solution la plus simple pour mettre à jour la page
            } else {
                modalContentWrapper.innerHTML = data.form_html;
                modalContentWrapper.querySelector('form').addEventListener('submit', handleFormSubmit);
            }
        })
        .catch(error => console.error('Form Submit Error:', error));
    }

    // --- GESTION GÉNÉRIQUE DE LA MODALE DE SUPPRESSION ---
    const confirmDeleteModalEl = document.getElementById('confirmDeleteModal');
    const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
    const deleteForm = document.getElementById('deleteForm');

    document.querySelectorAll('.js-delete-btn').forEach(button => {
        button.addEventListener('click', function(event) {
            event.preventDefault();
            const url = this.dataset.url;
            deleteForm.action = url;
            confirmDeleteModal.show();
        });
    });
});
</script>
{% endblock %}
{% comment %} 
{% extends "base.html" %}
{% load static %}

{% block title %}Liste des Produits - Gestion multi-boutiques{% endblock %}

{% block content %}
{# Nous n'avons plus besoin de charger static ici car c'est déjà fait en haut #}
{# Nous n'avons plus besoin des balises <html>, <head>, <body> car elles viennent de "base.html" #}

<style>
    /* Styles de la page (inchangés) */
    body { background: #f6f8fb; font-family: Inter, sans-serif; margin:0; }
    .container { max-width:1400px; margin:30px auto; }
    .card { border-radius:14px; box-shadow:0 2px 20px #dbe6ff80; background:#fff; margin-bottom:28px; padding:22px; }
    .dashboard-grid { display:flex; gap:34px; }
    .col { flex:1; min-width:0;}
    .table-wrapper { overflow:auto; margin-bottom:24px; }
    table { width: 100%; border-collapse:collapse; background:#fff; }
    thead { background: #f1f3f9;}
    th, td { padding: 13px 10px; border-bottom:1px solid #eaeaea;}
    th { font-weight:600; color: #4361ee; }
    tr:hover { background: #f1f6ff;}
    /* ================================================= */
/* AJOUTEZ CE BLOC CSS DANS VOTRE BALISE <style> */
/* ================================================= */

/* Conteneur pour les boutons dans la cellule du tableau */
.actions {
    display: flex;
    align-items: center;
    gap: 8px; /* Crée un espace propre entre les boutons */
}

/* Style de base pour chaque bouton d'action */
.actions .btn-action {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    border-radius: 50%; /* Pour obtenir un cercle parfait */
    text-decoration: none;
    transition: background-color 0.2s ease;
    font-size: 1rem;
    color: #3b5bdb; /* Couleur de base pour l'icône */
}

/* Style spécifique pour le bouton "Modifier" au survol */
.actions .btn-action-edit:hover {
    background-color: #eef2ff; /* Fond bleu très clair au survol */
    color: #4361ee;
}

/* Style spécifique pour le bouton "Supprimer" */
.actions .btn-action-delete {
    color: #e53e3e; /* Couleur de l'icône (rouge pour danger) */
}

.actions .btn-action-delete:hover {
    background-color: #fff1f1; /* Fond rouge très clair au survol */
}
    /* NOUVEAUX STYLES POUR LA FENÊTRE MODALE */
    .modal {
        display: none; /* Cachée par défaut */
        position: fixed; /* Reste en place même si on scrolle */
        z-index: 1000; /* Se place au-dessus de tout le reste */
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto; /* Permet de scroller si le contenu est trop grand */
        background-color: rgba(0,0,0,0.5); /* Fond noir semi-transparent */
    }

    .modal-content {
        background-color: #fff;
        margin: 10% auto; /* 10% du haut et centré horizontalement */
        padding: 25px;
        border: 1px solid #888;
        width: 80%;
        max-width: 600px; /* Largeur maximale */
        border-radius: 14px;
        box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19);
        position: relative; /* Pour positionner le bouton de fermeture */
    }

    .close-button {
        color: #aaa;
        position: absolute;
        top: 10px;
        right: 20px;
        font-size: 28px;
        font-weight: bold;
    }

    .close-button:hover,
    .close-button:focus {
        color: black;
        text-decoration: none;
        cursor: pointer;
    }

    .btn-primary {
        background-color: #4361ee;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        text-decoration: none;
        display: inline-block;
    }
    .btn-primary:hover {
        background-color: #3b5bdb;
    }
      
.stat-cards-row {
    display: flex;
    gap: 18px;
    padding: 18px;
    background: #f7f8fa;
    max-width: 1700px;
    margin: auto;
}

.stat-card {
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px #e5ecfa;
    min-width: 260px;
    flex: 1 1 0;
    padding: 22px 24px 12px 24px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    min-height: 110px;
}

.stat-card-head {
    font-size: .97em;
    color: #9ea4b1;
    letter-spacing: 0.02em;
    margin-bottom: 7px;
    font-weight: 450;
}
.stat-card-body {
    display: flex;
    align-items: center;
    justify-content: space-between;
    min-height: 45px;
}
.stat-value {
    font-size: 2.05em;
    color: #384052;
    font-weight: 700;
    letter-spacing: 0.01em;
}
.stat-value.big { font-size: 2em; }
.stat-pct {
    color: #bac0cd;
    font-size: 0.6em;
    font-weight: 500;
    margin-left: 3px;
}
.stat-pct.hires { color: #bac0cd;font-size: 1em;}
.stat-icon {
    font-size: 2em;
    vertical-align: middle;
    padding-right: 7px;
}
.stat-icon.up { color: #38d39f; }
.stat-icon.down { color: #ff4d6d; }
.stat-icon.plus { color: #38d39f;font-size:1.7em;}
.stat-dollar {
    color: #fed042;
    font-weight: bold;
    font-size: 1.35em;
    margin-right: 4px; 
}
.stat-value.hires { font-size: 2em;}
.stat-circular {
    display: inline-flex;
    justify-content: center;
    align-items: center;
    width: 44px; height: 44px;
    border-radius: 50%;
    background: #f7f8fa;
    font-size: 1em;
    font-weight: bold;
    box-shadow: 0 0 0 3px #eee;
    position: relative;
    margin-left: 18px;
}
.stat-circular span { font-size: 1em; }
.stat-circular.stat-blue  { box-shadow: 0 0 0 3px #2e86ff;}
.stat-circular.stat-red   { box-shadow: 0 0 0 3px #ea4e51;}
.stat-circular.stat-orange{ box-shadow: 0 0 0 3px #ffa700;}
.stat-circular.stat-green { box-shadow: 0 0 0 3px #42e695;}
.stat-bar {
    margin-top:14px;
    height: 4px;
    border-radius: 2px;
    width: 100%;
    background: #e7ecf3;
}
.stat-bar.stat-blue   { background: #2e86ff;}
.stat-bar.stat-red    { background: #ea4e51;}
.stat-bar.stat-orange { background: #ffa700;}
.stat-bar.stat-green  { background: #42e695;}
@media(max-width:1000px){
  .stat-cards-row { flex-direction: column;}
  .stat-card { margin-bottom: 16px;}
}
</style>
<div class="stat-cards-row">
  <!-- CARD 1 -->
  <div class="stat-card">
    <div class="stat-card-head">NEW ACCOUNTS</div>
    <div class="stat-card-body">
      <span class="stat-icon up">&#9650;</span>
      <span class="stat-value">234 <span class="stat-pct">%</span></span>
      <span class="stat-circular stat-blue"><span>58</span></span>
    </div>
    <div class="stat-bar stat-blue"></div>
  </div>
  <!-- CARD 2 -->
  <div class="stat-card">
    <div class="stat-card-head">TOTAL EXPENSES</div>
    <div class="stat-card-body">
      <span class="stat-icon down">&#9660;</span>
      <span class="stat-value">71 <span class="stat-pct">%</span></span>
      <span class="stat-circular stat-red"><span>62</span></span>
    </div>
    <div class="stat-bar stat-red"></div>
  </div>
  <!-- CARD 3 -->
  <div class="stat-card">
    <div class="stat-card-head">COMPANY VALUE</div>
    <div class="stat-card-body">
      <span class="stat-dollar">$</span>
      <span class="stat-value big">1,45M</span>
      <span class="stat-circular stat-orange"><span>72</span></span>
    </div>
    <div class="stat-bar stat-orange"></div>
  </div>
  <!-- CARD 4 -->
  <div class="stat-card">
    <div class="stat-card-head">NEW EMPLOYEES</div>
    <div class="stat-card-body">
      <span class="stat-icon plus">+</span>
      <span class="stat-value hires">34 <span class="stat-pct hires">hires</span></span>
      <span class="stat-circular stat-green"><span>81</span></span>
    </div>
    <div class="stat-bar stat-green"></div>
  </div>
</div>
<style>
</style>
<div class="container">
  
    <!-- Tableau Produits -->
    <div class="card">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
            <h2 style="margin: 0; color:#233c59"><i class="fa fa-database"></i> Produits</h2>
            <!-- MODIFICATION : On change le <a> pour un <button> et on lui donne un ID -->
            <button id="open-modal-btn" class="btn-primary">Ajouter un produit</button>
        </div>

        <div class="table-wrapper">
            <table>
                <thead>
                  <tr>
                    <th>Nom</th>
                    <th>Description</th>
                    <th>Prix Unitaire (€)</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                    {% for produit in produits %}
                      <tr>
                        <td>{{ produit.nom }}</td>
                        <td>{{ produit.description|truncatechars:32 }}</td>
                        <td>{{ produit.prix_unitaire }}
                          
                        </td>
                        <td class="actions">
                       <a href="#" class="btn btn-outline-secondary"><i class="fa fa-edit"></i> Secondary</a>
                        <a href="#" class="btn btn-outline-success"><i class="fa fa-edit"></i> Success</a>
<a href="#" class="btn btn-outline-info"><i class="fa fa-edit"></i> Info</a>
<a href="{% url 'produit_delete' produit.id %}" class="btn btn-outline-warning" title="Supprimer">
    <i class="fa fa-trash"></i> Warning
</a>
                        </td>
                      </tr>
                    {% empty %}
                      <tr>
                        <td colspan="4" style="text-align:center">Aucun produit</td>
                      </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- =========== LA STRUCTURE DE LA MODALE =========== -->
<div id="product-modal" class="modal">
  <div class="modal-content">
    <span class="close-button">×</span>
    <div id="modal-body">
        <!-- Le contenu du formulaire sera chargé ici par JavaScript -->
        <p>Chargement du formulaire...</p>
    </div>
  </div>
</div>


<script>
document.addEventListener('DOMContentLoaded', function () {
    // Récupérer les éléments de la modale
    const modal = document.getElementById('product-modal');
    const openBtn = document.getElementById('open-modal-btn');
    const closeBtn = document.querySelector('.close-button');
    const modalBody = document.getElementById('modal-body');

    // URL pour récupérer le formulaire de création
    const createFormUrl = "{% url 'produit_create' %}";

    // Fonction pour ouvrir la modale et charger le formulaire
    const openModal = () => {
        modal.style.display = 'block';
        // Utilise fetch pour récupérer le formulaire depuis la vue Django
        fetch(createFormUrl)
            .then(response => response.text())
            .then(html => {
                modalBody.innerHTML = html;
                // Attacher l'événement de soumission au nouveau formulaire
                const form = modalBody.querySelector('form');
                form.addEventListener('submit', handleFormSubmit);
            })
            .catch(error => {
                modalBody.innerHTML = "<p>Erreur lors du chargement du formulaire.</p>";
                console.error('Error fetching form:', error);
            });
    };

    // Fonction pour fermer la modale
    const closeModal = () => {
        modal.style.display = 'none';
        modalBody.innerHTML = '<p>Chargement du formulaire...</p>'; // Réinitialiser le contenu
    };

    // Gérer la soumission du formulaire via AJAX
    const handleFormSubmit = (event) => {
        event.preventDefault(); // Empêche la soumission classique de la page
        const form = event.target;
        const formData = new FormData(form);

        fetch(form.action, {
            method: 'POST',
            body: formData,
            headers: {
                // Django a besoin de ce header pour la protection CSRF avec AJAX
                'X-CSRFToken': form.querySelector('[name=csrfmiddlewaretoken]').value
            }
        })
        .then(response => response.json()) // On attend une réponse JSON du serveur
        .then(data => {
            if (data.success) {
                closeModal();
                location.reload(); // Recharger la page pour voir le nouveau produit
            } else {
                // Si la soumission a échoué (ex: validation), on réaffiche le formulaire avec les erreurs
                modalBody.innerHTML = data.form_html;
                 // Il faut ré-attacher l'événement car le contenu a été remplacé
                const newForm = modalBody.querySelector('form');
                newForm.addEventListener('submit', handleFormSubmit);
            }
        })
        .catch(error => {
            console.error('Error submitting form:', error);
            alert("Une erreur s'est produite. Veuillez réessayer.");
        });
    };

    // Événements
    openBtn.addEventListener('click', openModal);
    closeBtn.addEventListener('click', closeModal);

    // Fermer la modale si l'utilisateur clique en dehors de la boîte de contenu
    window.addEventListener('click', (event) => {
        if (event.target === modal) {
            closeModal();
        }
    });
});
</script>

{% endblock %}
{% comment %} {% extends "base.html" %}
{% load static %}

{% block title %}Nouvelle Vente - Gestion multi-boutiques{% endblock %}

{% block content %}

<h1>Liste des produits</h1>
<a href="{% url 'produit_create' %}">Ajouter un produit</a>
<ul>
  {% for produit in produits %}
    <li>
      <a href="{% url 'produit_detail' produit.pk %}">{{ produit.nom }}</a>
      - {{ produit.prix_unitaire }}€
      <a href="{% url 'produit_update' produit.pk %}">Modifier</a>
      <a href="{% url 'produit_delete' produit.pk %}">Supprimer</a>
    </li>
  {% empty %}
    <li>Aucun produit.</li>
  {% endfor %}
</ul>
{% endblock %}  {% endcomment %}
