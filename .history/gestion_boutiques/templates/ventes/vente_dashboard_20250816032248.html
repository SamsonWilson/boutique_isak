
{% comment %} {% extends "base.html" %}
{% load static %}
{% block content %}
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Nouvelle Vente</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .modal-overlay {display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);align-items:center;justify-content:center;}
        .modal-content {background:white;padding:20px;border-radius:8px;width:400px;}
        .receipt-table th, .receipt-table td {padding:10px;}
    </style>
</head>
<body>
<div class="container mt-5">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4>üõí Nouvelle Vente</h4>
        </div>
        <div class="card-body">
            <form method="POST" id="sale-form">
                {% csrf_token %}

                <!-- Client -->
                <h5 class="mt-3">üë§ Informations du Client</h5>
                <div class="row mb-3">
                    <div class="col-md-4">
                        {{ form.nom.label_tag }}
                        {{ form.nom }}
                    </div>
                    <div class="col-md-4">
                        {{ form.contact.label_tag }}
                        {{ form.contact }}
                    </div>
                    <div class="col-md-4">
                        {{ form.adresse.label_tag }}
                        {{ form.adresse }}
                    </div>
                </div>

                <hr>

                <!-- Recherche produit -->
                <h5>üîé Ajouter des Produits</h5>
                <input type="text" id="product-search" class="form-control" placeholder="Chercher un produit...">
                <div id="search-results" class="list-group mt-2"></div>

                <!-- Ticket de caisse -->
                <h3 class="mt-4">Re√ßu Client</h3>
                <table class="table table-bordered receipt-table">
                    <thead class="table-light">
                        <tr>
                            <th>Produit</th>
                            <th>Prix Unitaire</th>
                            <th>Quantit√©</th>
                            <th>Sous-total</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="receipt-items"></tbody>
                </table>

                <div class="text-end">
                    <h4>Total √† payer : <span id="total-price">0.00 ‚Ç¨</span></h4>
                </div>

                <!-- Champ cach√© pour envoyer donn√©es -->
                <input type="hidden" name="items" id="items-input">

                <div class="mt-3">
                    <button type="submit" class="btn btn-success">üíæ Enregistrer la Vente</button>
                    <button type="button" onclick="window.print()" class="btn btn-secondary">üñ®Ô∏è Imprimer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modale quantit√© -->
<div id="quantity-modal" class="modal-overlay">
    <div class="modal-content">
        <h5 id="modal-product-name"></h5>
        <label>Quantit√©</label>
        <input type="number" id="modal-quantity-input" min="1" value="1" class="form-control">
        <div class="mt-3 text-end">
            <button id="modal-cancel-btn" type="button" class="btn btn-secondary">Annuler</button>
            <button id="modal-confirm-btn" type="button" class="btn btn-primary">Ajouter</button>
        </div>
    </div>
</div>

<script>
const modal = document.getElementById("quantity-modal");
let selectedProduct = null;

const searchUrl = "{% url 'search_product' %}"; // ‚úÖ correction Django URL

// üîé Recherche AJAX
document.getElementById("product-search").addEventListener("keyup", function () {
    let q = this.value.trim();
    let results = document.getElementById("search-results");

    if (q.length <= 1) {
        results.innerHTML = "";
        return;
    }

    fetch(`${searchUrl}?q=${encodeURIComponent(q)}`)
        .then(res => res.json())
        .then(data => {
            results.innerHTML = "";

            if (data.length === 0) {
                let emptyMsg = document.createElement("div");
                emptyMsg.className = "list-group-item text-muted";
                emptyMsg.textContent = "Aucun produit trouv√©";
                results.appendChild(emptyMsg);
                return;
            }

            data.forEach(p => {
                let item = document.createElement("button");
                item.className = "list-group-item list-group-item-action";
                item.type = "button";

                // D√©terminer la couleur selon la quantit√©
                let stockColor = "orange"; // par d√©faut
                if (p.quantite > 20) {
                    stockColor = "green";
                } else if (p.quantite < 5) {
                    stockColor = "red";
                }

                // Contenu avec couleur pour la quantit√©
                item.innerHTML = `${p.nom} - ${p.prix_unitaire}‚Ç¨ 
                    <span style="color:${stockColor}; font-weight:bold;">
                        (Stock: ${p.quantite})
                    </span>`;

                item.onclick = () => openModal(p);
                results.appendChild(item);
            });
        })
        .catch(err => {
            console.error("Erreur lors de la recherche :", err);
        });
});


// üî≤ Ouvrir modale
function openModal(product){
    selectedProduct = product;
    document.getElementById("modal-product-name").textContent = product.nom;
    document.getElementById("modal-quantity-input").value = 1;
    modal.style.display = "flex";
}

// ‚ùå Fermer modale
document.getElementById("modal-cancel-btn").onclick = () => modal.style.display = "none";

// ‚úÖ Ajouter produit au ticket
document.getElementById("modal-confirm-btn").onclick = addProduct;

function addProduct(){
    let qte = parseInt(document.getElementById("modal-quantity-input").value);
    let tbody = document.getElementById("receipt-items");
    let tr = document.createElement("tr");

    let prix = parseFloat(selectedProduct.prix);   // <- correction
    let subtotal = (prix * qte).toFixed(2);

    tr.innerHTML = `
        <td>${selectedProduct.nom}</td>
        <td>${prix}‚Ç¨</td>
        <td>${qte}</td>
        <td>${subtotal}‚Ç¨</td>
        <td><button type="button" class="btn btn-danger btn-sm">üóëÔ∏è</button></td>
    `;
    tr.dataset.id = selectedProduct.id;
    tr.dataset.prix = prix;
    tr.dataset.quantite = qte;

    tr.querySelector("button").onclick = () => {
        tr.remove();
        updateTotal();
    };

    tbody.appendChild(tr);

    updateTotal();
    modal.style.display = "none";
}

// üîÑ Calcul du total
function updateTotal(){
    let rows = document.querySelectorAll("#receipt-items tr");
    let total = 0;
    let items = [];
    rows.forEach(r=>{
        let prix = parseFloat(r.dataset.prix);
        let qte = parseInt(r.dataset.quantite);
        total += prix * qte;
        items.push({id:r.dataset.id, prix: prix, quantite: qte});
    });
    document.getElementById("total-price").textContent = total.toFixed(2) + " ‚Ç¨";
    document.getElementById("items-input").value = JSON.stringify(items);
}
</script>
</body>
</html> 

